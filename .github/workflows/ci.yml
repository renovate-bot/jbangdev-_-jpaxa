name: CI

on:
  push:
  pull_request:

permissions:
  contents: read

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  variants-smoke:
    name: Build stubs + build all variants (smoke)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22.x"

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Set up jbang
        uses: jbangdev/setup-jbang@main

      - name: Build stubs
        run: ./compile-stubs.sh

      - name: Tar stubs (preserve permissions)
        shell: bash
        run: |
          set -euo pipefail
          tar -czf stubs.tgz stubs

      - name: Upload stubs artifact
        uses: actions/upload-artifact@v4
        with:
          name: stubs-tgz
          path: stubs.tgz
          if-no-files-found: error


      - name: Package example for all variants
        shell: bash
        run: |
          set -euo pipefail
          rm -rf dist
          mkdir -p dist

          # Compile the example as part of the build (don't rely on a prebuilt class file)
          javac examples/simple-java/Hello.java

          jbang ./jpaxa.java \
            examples/simple-java \
            --directory dist \
            --output hello \
            --variants all \
            -- "java" "-cp" "{{app}}" "Hello"

          test -f "dist/hello-windows-x86_64.exe"
          for v in osx-x86_64 osx-aarch64 linux-x86_64 linux-aarch_64 linux-arm; do
            echo "Testing ${v}"
            test -f "dist/hello-${v}"
          done

          ls -la dist

          tar -czf hello-dist.tgz dist

      - name: Upload hello artifact
        uses: actions/upload-artifact@v4
        with:
          name: hello-dist-tgz
          path: hello-dist.tgz
          if-no-files-found: error

      - name: setup jpaxa exec
        shell: bash
        run: |
          set -euo pipefail
          mkdir examples/jpaxa-exec
          cd examples/jpaxa-exec
          jbang wrapper install
          # export jpaxa.java with the stubs included
          jbang export fatjar --files=stubs/=../../stubs --force ../../jpaxa.java
          ls -la 
  
      - name: Package jpaxa
        shell: bash
        run: |
          set -euo pipefail
          rm -rf dist
          mkdir -p dist

          jbang ./jpaxa.java \
            examples/jpaxa-exec \
            --directory jpaxa-exec-dist \
            --output jpaxa-exec \
            --variants all
            -- "{{app}}/jbang"

          tar -czf jpaxa-exec-dist.tgz jpaxa-exec-dist

      - name: Upload jpaxa-exec artifact
        uses: actions/upload-artifact@v4
        with:
          name: jpaxa-exec
          path: jpaxa-exec-dist.tgz
          if-no-files-found: error

  platform-matrix:
    name: Package + run on ${{ matrix.name }}
    needs: [variants-smoke]
    runs-on: ${{ matrix.runs_on }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: linux-x64
            runs_on: ubuntu-latest
            variant: linux-x86_64
            output: hello
            run_cmd: ./dist/hello-linux-x86_64 CI

          # Hosted arm64 runners are not available in all orgs. If this fails to schedule,
          # remove this entry.
          #- name: linux-arm64
          #  runs_on: ubuntu-24.04-arm64
          #  variant: linux-aarch64
          #  output: hello
          #  run_cmd: ./dist/hello-linux-aarch64 CI

          - name: macos-x64
            runs_on: macos-15-intel
            variant: darwin-x86_64
            output: hello
            run_cmd: ./dist/hello-darwin-x86_64 CI

          - name: macos-arm64
            runs_on: macos-latest
            variant: darwin-aarch64
            output: hello
            run_cmd: ./dist/hello-darwin-aarch64 CI

          - name: windows-x64
            runs_on: windows-latest
            variant: windows-x86_64
            output: hello.exe

    steps:
      - uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Set up jbang
        uses: jbangdev/setup-jbang@main

      - name: Download stubs
        uses: actions/download-artifact@v4
        with:
          name: stubs-tgz
          path: .

      - name: Download hello
        uses: actions/download-artifact@v4
        with:
          name: hello-dist-tgz
          path: .

      - name: Run packaged app (unix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          set -euo pipefail
          tar -xzf stubs.tgz
          tar -xzf hello-dist.tgz
          chmod +x dist/hello-${{ matrix.variant }} || true
          out="$(${{ matrix.run_cmd }})"
          echo "$out"
          echo "$out" | grep -F "Hello from packaged Java application!"
          echo "$out" | grep -F "Arguments: CI"

      - name: Run packaged app (windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          tar -xzf stubs.tgz
          tar -xzf hello-dist.tgz
          $exe = "dist\hello-windows-x86_64.exe"
          if (!(Test-Path $exe)) { throw "Expected output not found: $exe" }
          $outLines = & $exe CI
          $outText = ($outLines -join "`n")
          Write-Host $outText
          if ($outText -notmatch "Hello from packaged Java application!") { throw "Missing expected greeting" }
          if ($outText -notmatch "Arguments: CI") { throw "Missing expected arguments line" }

