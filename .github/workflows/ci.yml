name: CI

on:
  push:
  pull_request:

permissions:
  contents: read

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  variants-smoke:
    name: Build stubs + build all variants (smoke)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: jdx/mise-action@v3

      - name: Assemble jpaxa
        run: |
         jreleaser assemble

      - name: Tar build (preserve permissions)
        shell: bash
        run: |
          set -euo pipefail
          tar -czf build.tgz build

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: build-tgz
          path: build.tgz
          if-no-files-found: error

  platform-matrix:
    name: Package + run on ${{ matrix.name }}
    needs: [variants-smoke]
    runs-on: ${{ matrix.runs_on }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: linux-x64
            runs_on: ubuntu-latest
            variant: linux-x86_64
            output: hello
            run_cmd: ./dist/jpaxa-linux-x86_64 CI

          # Hosted arm64 runners are not available in all orgs. If this fails to schedule,
          # remove this entry.
          #- name: linux-arm64
          #  runs_on: ubuntu-24.04-arm64
          #  variant: linux-aarch_64
          #  output: hello
          #  run_cmd: ./dist/hello-linux-aarch_64 CI

          - name: macos-x64
            runs_on: macos-15-intel
            variant: osx-x86_64
            output: hello
            run_cmd: ./dist/jpaxa-osx-x86_64 CI

          - name: macos-arm64
            runs_on: macos-latest
            variant: osx-aarch_64
            output: hello
            run_cmd: ./dist/jpaxa-osx-aarch_64 CI

          - name: windows-x64
            runs_on: windows-latest
            variant: windows-x86_64
            output: ./dist/jpaxa-windows-x86_64.exe

    steps:
      - uses: actions/checkout@v4
      - uses: jdx/mise-action@v3

      - name: Download build
        uses: actions/download-artifact@v4
        with:
          name: build-tgz
          path: .

      - name: Run packaged app (unix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          set -euo pipefail
          tar -xzf stubs.tgz
          tar -xzf hello-dist.tgz
          chmod +x dist/hello-${{ matrix.variant }} || true
          out="$(${{ matrix.run_cmd }})"
          echo "$out"
          echo "$out" | grep -F "Hello from packaged Java application!"
          echo "$out" | grep -F "Arguments: CI"

      - name: Run packaged app (windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          tar -xzf stubs.tgz
          tar -xzf hello-dist.tgz
          $exe = "dist\hello-windows-x86_64.exe"
          if (!(Test-Path $exe)) { throw "Expected output not found: $exe" }
          $outLines = & $exe CI
          $outText = ($outLines -join "`n")
          Write-Host $outText
          if ($outText -notmatch "Hello from packaged Java application!") { throw "Missing expected greeting" }
          if ($outText -notmatch "Arguments: CI") { throw "Missing expected arguments line" }

